name: ðŸ”´ NEXO Real-Time Error Detection & Auto-Repair

on:
  workflow_dispatch:
    inputs:
      log_url:
        description: 'URL ou caminho do arquivo de log NEXO'
        required: false
        default: 'nexo_lucro.log'
  schedule:
    # Monitora a cada 10 minutos
    - cron: '*/10 * * * *'
  push:
    paths:
      - 'srodolfobarbosa/deus.py'
      - 'srodolfobarbosa/nexo_*.py'

jobs:
  detect-and-repair:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd srodolfobarbosa
          pip install -q -r requirements.txt
          pip install -q ruff black pytest supabase-py
      
      - name: ðŸ” Scan for NEXO Errors
        id: scan
        run: |
          cd srodolfobarbosa
          
          # Procura por logs do NEXO
          LOG_FILE="nexo_lucro.log"
          if [ ! -f "$LOG_FILE" ]; then
            LOG_FILE="nexo_seguranca.log"
          fi
          
          if [ ! -f "$LOG_FILE" ]; then
            echo "â„¹ï¸ Nenhum arquivo de log NEXO encontrado"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT
          
          # Executa detector
          python nexo_error_repair.py --log-file "$LOG_FILE" | tee scan_results.txt
      
      - name: ðŸ”§ Auto-Repair NEXO Errors
        if: steps.scan.outputs.found == 'true'
        run: |
          cd srodolfobarbosa
          python nexo_error_repair.py --log-file "${{ steps.scan.outputs.log_file }}" --auto-fix
      
      - name: âœ“ Validate Fixes
        if: steps.scan.outputs.found == 'true'
        run: |
          cd srodolfobarbosa
          python -m pytest test_smoke.py -v || true
      
      - name: ðŸ“¤ Create Issue if Errors Found
        if: steps.scan.outputs.found == 'true' && failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('srodolfobarbosa/scan_results.txt', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”´ NEXO Errors Detected - Manual Review Required',
              body: `## NEXO Error Report\n\n\`\`\`\n${results}\n\`\`\`\n\nâš ï¸ Some errors may require manual intervention. Please review the fixes applied.`,
              labels: ['nexo-error', 'auto-repair'],
              assignees: ['srodolfobarbosa']
            });
      
      - name: ðŸ“Š Report Summary
        if: always()
        run: |
          echo "## ðŸ¤– NEXO Auto-Repair Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ -f "srodolfobarbosa/scan_results.txt" ]; then
            echo "- **Status**: Errors detected and attempted fixes" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: No errors detected" >> $GITHUB_STEP_SUMMARY
          fi
