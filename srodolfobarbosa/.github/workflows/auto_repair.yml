name: Auto Repair with Sandbox Validation

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

jobs:
  auto-repair:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10
      
      - name: Install dependencies
        run: |
          cd srodolfobarbosa && pip install -q -r requirements.txt
          pip install -q ruff black pytest python-dotenv requests
      
      - name: Run Auto-Repair Agent with Sandbox Validation
        env:
          AUTO_INSTALL: ${{ vars.AUTO_INSTALL | default('true') }}
          AGGRESSIVE_FIXES: ${{ vars.AGGRESSIVE_FIXES | default('false') }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd srodolfobarbosa
          ARGS="--sandbox --auto-apply --api-url http://localhost:8000"
          if [ "${AGGRESSIVE_FIXES}" = "true" ]; then
            ARGS="$ARGS --unsafe-fixes"
          fi
          python scripts/auto_repair.py $ARGS || true
      
      - name: Report sandbox results
        if: always()
        run: |
          if [ -f srodolfobarbosa/.sandbox/history.jsonl ]; then
            echo "ðŸ“Š Ãšltimos resultados de sandbox:"
            tail -1 srodolfobarbosa/.sandbox/history.jsonl | python -m json.tool || true
          fi

            await github.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI failed: Automatic repair attempted for ${context.repo.repo}`,
              body: `The CI workflow failed for commit ${run.head_sha}. The auto-repair workflow attempted fixes and may have opened a PR. See CI run: ${url}`
            })
