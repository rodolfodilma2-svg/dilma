name: Auto Repair

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

jobs:
  auto-repair:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir -r requirements.txt
      - name: Run auto_repair (try to fix and open PR)
        env:
          AUTO_INSTALL: ${{ vars.AUTO_INSTALL | default('true') }}
          AGGRESSIVE_FIXES: ${{ vars.AGGRESSIVE_FIXES | default('false') }}
          AUTO_REPAIR_LABELS: ${{ vars.AUTO_REPAIR_LABELS | default('auto-repair') }}
          AUTO_REPAIR_ASSIGNEES: ${{ vars.AUTO_REPAIR_ASSIGNEES || '' }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARGS="--open-pr --labels \"${AUTO_REPAIR_LABELS}\" --assignees \"${AUTO_REPAIR_ASSIGNEES}\" --auto-merge"
          if [ "${AGGRESSIVE_FIXES}" = "true" ]; then
            ARGS="$ARGS --unsafe-fixes"
          fi
          python scripts/auto_repair.py $ARGS || true
      - name: Create issue to notify maintainers
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run
            const url = run ? run.html_url : ''
            await github.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI failed: Automatic repair attempted for ${context.repo.repo}`,
              body: `The CI workflow failed for commit ${run.head_sha}. The auto-repair workflow attempted fixes and may have opened a PR. See CI run: ${url}`
            })
